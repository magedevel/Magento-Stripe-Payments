var district=district||{};district.stripeCc=function($){var mageValidateParent,self={},$errorMsg=$("#stripe-error-messages"),$inputs={},address={},cardsMap={AE:"amex",DI:"discover",DC:"dinersclub",JCB:"jcb",MC:"mastercard",VI:"visa"},allowedCards=[],tokenValues={cardNumber:"",cardExpiry:"",cardCVC:""};return self.init=function(enabledCards){self.setupEnabledCards(enabledCards),$inputs.cardNumber=$("input#stripe_cc_number"),$inputs.cardExpiry=$("input#stripe_cc_exp"),$inputs.cardCVC=$("input#stripe_cc_cvc"),$inputs.cardToken=$("input#stripe_token"),$inputs.savedCard=$("select#stripe-saved-card"),$inputs.cardNumber.payment("formatCardNumber"),$inputs.cardExpiry.payment("formatCardExpiry"),$inputs.cardCVC.payment("formatCardCVC"),$.fn.toggleInputError=function(error){return this.parent().toggleClass("has-error",error),this},$inputs.savedCard.change(function(){""===$(this).val()?($("#stripe-cards-select-new").show(),$inputs.cardNumber.focus()):$("#stripe-cards-select-new").hide()}),"undefined"!=typeof Payment?("undefined"!=typeof billing&&self.getBillingAddressFrontend(),$("body").on("keyup","input#stripe_cc_number, input#stripe_cc_exp, input#stripe_cc_cvc",function(){self.delay(self.cardEntryListener,1e3)}),Payment.prototype.save=Payment.prototype.save.wrap(self.paymentSave)):"undefined"!=typeof AdminOrder&&(AdminOrder.prototype.submit=AdminOrder.prototype.submit.wrap(self.validateForm),AdminOrder.prototype.getPaymentData=AdminOrder.prototype.getPaymentData.wrap(self.paymentDataChange))},self.delay=function(){var timer=0;return function(callback,ms){clearTimeout(timer),timer=setTimeout(callback,ms)}}(),self.cardEntryListener=function(){self.validCard()&&self.newTokenRequired()&&self.createToken()},self.validCard=function(){var validCardNumber=!1,validCardExpiry=!1,validCardCVC=!1;return""!==$.trim($inputs.cardNumber.val())&&(validCardNumber=$.payment.validateCardNumber($inputs.cardNumber.val()),$inputs.cardNumber.toggleInputError(!validCardNumber)),""!==$.trim($inputs.cardExpiry.val())&&(validCardExpiry=$.payment.validateCardExpiry($.payment.cardExpiryVal($inputs.cardExpiry.val())),$inputs.cardExpiry.toggleInputError(!validCardExpiry)),""!==$.trim($inputs.cardCVC.val())&&(validCardCVC=$.payment.validateCardCVC($inputs.cardCVC.val(),$.payment.cardType($inputs.cardNumber.val())),$inputs.cardCVC.toggleInputError(!validCardCVC)),validCardNumber&&validCardExpiry&&validCardCVC?!0:!1},self.newTokenRequired=function(){return $.trim($inputs.cardNumber.val())!==tokenValues.cardNumber||$.trim($inputs.cardExpiry.val())!==tokenValues.cardExpiry||$.trim($inputs.cardCVC.val())!==tokenValues.cardCVC?!0:!1},self.setupEnabledCards=function(enabledCards){var enabledCardsArr=enabledCards.split(",");$.each(cardsMap,function(mageKey,stripeKey){$.inArray(mageKey,enabledCardsArr)>-1&&allowedCards.push(stripeKey)})},self.paymentDataChange=function(getPaymentData){self.getBillingAddressAdmin(),getPaymentData()},self.getBillingAddressFrontend=function(){var $billingAddress=$("#billing-address-select");$billingAddress.length&&""!=$billingAddress.val()?$.ajax({url:billing.addressUrl+$billingAddress.val()}).done(function(data){address.line1=data.street1,address.zip=data.postcode,address.country=data.country_id,address.name=data.firstname+" "+data.lastname}):(address.line1=$("#billing\\:street1").val(),address.zip=$("#billing\\:postcode").val(),address.country=$("#billing\\:country_id").val(),address.name=$("billing\\:firstname").val()+" "+$("billing\\:lastname").val())},self.getBillingAddressAdmin=function(){address.line1=$("#order-billing_address_street0").val(),address.zip=$("#order-billing_address_postcode").val(),address.country=$("#order-billing_address_country_id").val(),address.name=$("#order-billing_address_firstname").val()+" "+$("#order-billing_address_lastname").val()},self.paymentSave=function(validateParent){if(mageValidateParent=validateParent,$inputs.savedCard.length&&""!==$inputs.savedCard.val())mageValidateParent();else{if(!self.validCard())return!1;var cardType=$.payment.cardType($inputs.cardNumber.val());if($.inArray(cardType,allowedCards)<0)return window.alert(Translator.translate("Sorry, "+cardType+" is not currently accepted. Please use a different card.").stripTags()),!1;mageValidateParent()}},self.createToken=function(){Stripe.card.createToken({number:$inputs.cardNumber.val(),exp:$inputs.cardExpiry.val(),cvc:$inputs.cardCVC.val(),address_country:address.country,address_line1:address.line1,address_zip:address.zip,name:address.name},self.stripeResponseHandler)},self.stripeResponseHandler=function(status,response){response.error?$errorMsg.html(response.error.message):(tokenValues.cardNumber=$.trim($inputs.cardNumber.val()),tokenValues.cardExpiry=$.trim($inputs.cardExpiry.val()),tokenValues.cardCVC=$.trim($inputs.cardCVC.val()),$inputs.cardToken.val(response.id))},self}(district.$);