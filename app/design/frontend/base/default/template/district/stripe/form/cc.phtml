<?php
/**
 * District Commerce
 *
 * @category    District
 * @package     Stripe
 * @author      District Commerce <support@districtcommerce.com>
 * @copyright   Copyright (c) 2015 District Commerce (http://districtcommerce.com)
 *
 */

$isStripeCustomer = false;
$savedCards = false;
$acceptedCards = Mage::getStoreConfig('payment/stripe_cc/cctype');
$acceptedCardsArr = explode(',', $acceptedCards);
$cardsMap = array(
    'VI' => array(
        'label' => 'Visa',
        'class' => 'visa',
    ),
    'MC' => array(
        'label' => 'Mastercard',
        'class' => 'mastercard',
    ),
    'AE' => array(
        'label' => 'American Express',
        'class' => 'amex',
    ),
    'DI' => array(
        'label' => 'Discover',
        'class' => 'discover',
    ),
    'DC' => array(
        'label' => 'Diners Club',
        'class' => 'dinersclub',
    ),
    'JCB' => array(
        'label' => 'JCB',
        'class' => 'jcb',
    ),

);

//If customer exists in Stripe
if($cust = Mage::helper('stripe')->retrieveCustomer()) {

    //Set customer flag
    $isStripeCustomer = true;

    //Get stored cards
    $cards = $cust->sources->data;

    //If there are stored cards, set saved cards flag
    if(sizeof($cards) > 0) {
        $savedCards = true;
    }
}

?>

<div class="form-list" id="payment_form_<?php echo $this->getMethodCode() ?>" style="display:none;">
    <div id="stripe-cards-select">
        <input type="hidden" name="stripeToken" id="stripe_token">
        <?php if($isStripeCustomer): ?>
        <input type="hidden" name="isStripeCustomer" value="1">
        <?php endif; ?>
        <div id="stripe-error-messages"></div>
        <?php if($savedCards): ?>
        <ol id="stripe-cards-select-saved">
            <li>
                <label for="stripe-saved-card" class="reader-visible"><?php echo $this->__('Choose card'); ?></label>
                <select id="stripe-saved-card" name="stripeSavedCard">
                    <?php foreach($cards as $card): ?>
                    <option value="<?php echo $card->id; ?>">
                        <?php echo $card->brand; ?> ****<?php echo $card->last4; ?> (<?php echo $card->exp_month . '/' . $card->exp_year; ?>)
                    </option>
                    <?php endforeach; ?>
                    <option value=""><?php echo $this->__('New card'); ?></option>
                </select>
            </li>
        </ol>
        <?php endif; ?>
        <ol id="stripe-cards-select-new" <?php if($savedCards): ?> style="display:none;"<?php endif; ?>>
            <li>
                <label for="stripe_cc_number" class="reader-visible"><?php echo $this->__('Card Number'); ?></label>
                <input id="stripe_cc_number" type="tel" x-autocompletetype="cc-number" autocompletetype="cc-number" autocorrect="off" spellcheck="off" autocapitalize="off" placeholder="<?php echo $this->__('Card Number'); ?>" data-stripe="number" size="20">
            </li>
            <li class="float">
                <label for="stripe_cc_exp" class="reader-visible"><?php echo $this->__('Expiry Date'); ?></label>
                <input id="stripe_cc_exp" type="tel" x-autocompletetype="off" autocompletetype="off" autocorrect="off" spellcheck="off" autocapitalize="off" placeholder="MM / YY" size="5" data-stripe="exp">
            </li>
            <li class="float">
                <label for="stripe_cc_cvc" class="reader-visible"><?php echo $this->__('CVC'); ?></label>
                <input id="stripe_cc_cvc" type="tel" autocomplete="off" autocorrect="off" spellcheck="off" autocapitalize="off" placeholder="<?php echo $this->__('CVC'); ?>" data-stripe="cvc" size="4" maxlength="4">
            </li>
            <?php if(Mage::getSingleton('customer/session')->isLoggedIn() && Mage::getStoreConfig('payment/stripe_cc/save_cc_enabled')): ?>
            <li id="stripe-cards-select-save">
                <label><input type="checkbox" name="stripeSaveCard" /> <?php echo $this->__('Save card'); ?></label>
            </li>
            <?php endif; ?>
        </ol>
    </div>

    <?php if(sizeof($acceptedCardsArr) > 0): ?>
    <div id="stripe-cards-info">
    <?php foreach($cardsMap as $cardKey => $cardInfo): ?>
    <?php if(in_array($cardKey, $acceptedCardsArr)): ?>
        <span class="district-cc district-cc-<?php echo $cardInfo['class']; ?>" title="<?php echo $cardInfo['label']; ?>"><?php echo $cardInfo['label']; ?></span>
    <?php endif ;?>
    <?php endforeach; ?>
    </div>
    <?php endif; ?>

</div>

<script>

    Stripe.setPublishableKey('<?php echo Mage::getStoreConfig('payment/stripe_cc/api_publishable_key'); ?>');

    (function() {
        district.stripeCc.init('<?php echo $acceptedCards; ?>');
    })();

</script>
